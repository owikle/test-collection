{% comment %}

    Embed Universal Viewer to load item from an IIIF manifest file, https://github.com/UniversalViewer/universalviewer 
    This include assumes that Item's object_location field is a relative link or direct url to a IIIF manifest json file. e.g. https://wellcomelibrary.org/iiif/b18035723/manifest 
    If you are using an external manifest url, you may encounter CORS policy error if the server hosting the manifest is not set up correctly--one workaround is to download the json file, add to your "objects" folder, and use a relative link, e.g. "objects/book-manifest1.json". You do not need the images, just the manifest file!

{% endcomment %}
<style>
    .mirador-close-window {
        display: none;
    }
</style>
<!-- add Mirador assets from CDN -->
<script src="https://unpkg.com/mirador@latest/dist/mirador.min.js"></script>
<!-- add div for viewer -->
<div id="mirador" class="h-100"></div>
<script type="text/javascript">
    // initialize Mirador
    function initializeMiradorViewer() {
        var mirador = Mirador.viewer({
            "id": "mirador",
            "manifests": {
                {{ page.objectid | prepend: "/objects/iiif/" | append: "/manifest.json" | relative_url | jsonify }}: {
                "provider": "Iowa State University"
                }
            },
            "windows": [
                {
                "loadedManifest": {{ page.objectid | prepend: "/objects/iiif/" | append: "/manifest.json" | relative_url | jsonify }},
                // "allowClose": false
                "view": "book",
                "allowMaximize": false
                }
            ],
            /*"workspaceControlPanel": {
                "enabled": false
            }*/
        });
        
        // Custom logic to handle the "x" button visibility and functionality
        document.addEventListener('fullscreenchange', function() {
            var closeButton = document.querySelector('[aria-label="Close window"]');
            if (document.fullscreenElement) {
                // Full screen mode entered
                if (closeButton) {
                    closeButton.style.display = 'block';
                    closeButton.addEventListener('click', exitFullScreenHandler);
                }
            } else {
                // Full screen mode exited
                if (closeButton) {
                    closeButton.style.display = 'none';
                    closeButton.removeEventListener('click', exitFullScreenHandler);
                }
            }
        });

        function exitFullScreenHandler(event) {
            event.preventDefault();
            event.stopPropagation();
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        // Ensure the close button is hidden initially
        window.addEventListener('load', function() {
            var closeButton = document.querySelector('[aria-label="Close window"]');
            if (closeButton) {
                closeButton.style.display = 'none';
            }
        });

        // Ensure the close button is hidden when a new window is opened in Mirador
        mirador.store.subscribe(function() {
            var closeButton = document.querySelector('[aria-label="Close window"]');
            if (closeButton && !document.fullscreenElement) {
                closeButton.style.display = 'none';
            }
        });
    }
    initializeMiradorViewer();
</script>